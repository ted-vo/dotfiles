#!/usr/bin/env bash

source "$SCRIPT_DIR/colorized"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
if [ "$OS" == "darwin" ]; then
  echo -e "$CNT - Detected system MacOS"
  OS="osx"
else
  echo -en "$CNT - Detected system Linux"
  if which yay >/dev/null; then
    echo -en ":: Distribution Arch\n"
  else
    echo -en ":: Distribution Ubuntu\n"
  fi
fi

ARCH="$(uname -m | tr '[:upper:]' '[:lower:]')"

INSTLOG="install.log"

show_progress() {
  while ps | grep $1 | grep -v grep &>/dev/null; do
    echo -n "."
    sleep 2
  done
  echo -en "Done!\n"
  sleep 2
}

# function that will test for a package and if not found it will attempt to install it
install_software() {
  if [[ $OS == 'linux' ]]; then
    if which yay >/dev/null; then
      arch_linux $@
    else
      ubuntu $@
    fi
  fi

  if [[ $OS == 'osx' ]]; then
    macos $@
  fi
}

macos() {
  if ! which brew &>/dev/null; then
    echo -e "$CNT - Homebrew not found. Installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    echo >>$HOME/.zshrc.local
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >>$HOME/.zshrc.local

    eval "$(/opt/homebrew/bin/brew shellenv)"

    echo -e "$COK - Config brew path done."
  fi

  s=$1

  # fix for cheat-bin not found in homebrew
  if [ "$s" == "cheat-bin" ]; then
    s="cheat"
  fi

  if brew list $s &>/dev/null; then
    echo -e "$COK - $s is already installed."
  else
    echo -en "$CNT - Now installing $1 ."
    brew install $s >>$INSTLOG 2>&1 &
    show_progress $!
    if brew list $s &>/dev/null; then
      echo -e "$COK - $s was installed."
    else
      # if this is hit then a package is missing, exit to review log
      echo -e "$CER - $s install had failed, please check the install.log"
      exit
    fi

  fi
}

ubuntu() {
  # First lets see if the package is there
  if dpkg -s $1 &>/dev/null; then
    echo -e "$COK - $1 is already installed."
  else
    # no package found so installing
    echo -en "$CNT - Now installing $1 ."
    apt install -y $1 >>$INSTLOG 2>&1 &
    show_progress $!
    # test to make sure package installed
    if dpkg -Q $1 &>/dev/null; then
      echo -e "$COK - $1 was installed."
    else
      # if this is hit then a package is missing, exit to review log
      echo -e "$CER - $1 install had failed, please check the install.log"
      exit
    fi
  fi
}

arch_linux() {
  # First lets see if the package is there
  if yay -Q $1 &>/dev/null; then
    echo -e "$COK - $1 is already installed."
  else
    # no package found so installing
    echo -en "$CNT - Now installing $1 ."
    yay -S --noconfirm $1 >>$INSTLOG 2>&1 &
    show_progress $!
    # test to make sure package installed
    if yay -Q $1 &>/dev/null; then
      echo -e "$COK - $1 was installed."
    else
      # if this is hit then a package is missing, exit to review log
      echo -e "$CER - $1 install had failed, please check the install.log"
      exit
    fi
  fi
}
